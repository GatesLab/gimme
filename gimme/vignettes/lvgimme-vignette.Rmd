---
title: "Latent Variable GIMME"
author: "Z. F. Fisher & K. M. Gates"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
header-includes: 
  - \usepackage{tikz}
vignette: >
  %\VignetteIndexEntry{MS GIMME}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(width=90)
```

## Introduction

This vignette will demonstrate the basic functionality available in latent variable gimme. 

## Example Data

The example data contains multivariate time series data for 20 subjects in two subgroups.   For each subject, 9 observed variable time series were generated based on 3 underlying latent time series. The data generating model for the first 10 subjects is given below under the heading Group 1 Model, and the second 10 subjects under the heading Group 2 model. For didactic purposes this data is homogenous at the individual level within each subgroup. This data is included in the  <tt>gimme</tt> package and is labeled <tt>simDataLV</tt>. 

### Preview Data for Subject 1

```{r}
head(round(gimme::simDataLV[[1]],2))
```

### Group 1 Model (N=10)

```{r,echo=FALSE, fig.show='hold',fig.width=7}
library(DiagrammeR)
grViz("
digraph SEM {
      
      graph [layout = neato,
      overlap = FALSE,
      outputorder = nodesfirst]
      
      node [shape = rectangle, fixedsize = TRUE, 
            height = 1.6, fontsize = 32, color = 'blue', 
            style ='filled', fontcolor = 'white']
      
      v1_lag  [pos = '0, 3!',  label = 'V1lag', shape = square]
      v2_lag  [pos = '2, 3!',  label = 'V2lag', shape = square]
      v3_lag  [pos = '4, 3!',  label = 'V3lag', shape = square]
      l1_lag [pos = '2, 0!', label = 'L1lag', shape = circle]
      l1_lag->v1_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1_lag->v2_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1_lag->v3_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]

      v1  [pos = '18, 3!',  label = 'V1', shape = square]
      v2  [pos = '20, 3!',  label = 'V2', shape = square]
      v3  [pos = '22, 3!',  label = 'V3', shape = square]
      l1 [pos = '20, 0!', label = 'L1', shape = circle]
      l1->v1 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1->v2 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1->v3 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]


      v4_lag  [pos = '0, -2!',  label = 'V4lag', shape = square]
      v5_lag  [pos = '2, -2!',  label = 'V5lag', shape = square]
      v6_lag  [pos = '4, -2!',  label = 'V6lag', shape = square]
      l2_lag [pos = '2, -5!', label = 'L2lag', shape = circle]
      l2_lag->v4_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2_lag->v5_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2_lag->v6_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]

      v4  [pos = '18, -2!',  label = 'V4', shape = square]
      v5  [pos = '20, -2!',  label = 'V5', shape = square]
      v6  [pos = '22, -2!',  label = 'V6', shape = square]
      l2 [pos = '20, -5!', label = 'L2', shape = circle]
      l2->v4 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2->v5 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2->v6 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]


      v7_lag  [pos = '0, -7!',  label = 'V7lag', shape = square]
      v8_lag  [pos = '2, -7!',  label = 'V8lag', shape = square]
      v9_lag  [pos = '4, -7!',  label = 'V9lag', shape = square]
      l3_lag [pos = '2, -10!', label = 'L3lag', shape = circle]
      l3_lag->v7_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3_lag->v8_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3_lag->v9_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]

      v7  [pos = '18, -7!',  label = 'V7', shape = square]
      v8  [pos = '20, -7!',  label = 'V8', shape = square]
      v9  [pos = '22, -7!',  label = 'V9', shape = square]
      l3 [pos = '20, -10!', label = 'L3', shape = circle]
      l3->v7 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3->v8 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3->v9 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]


      l1_lag->l1 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      l2_lag->l2 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      l3_lag->l3 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]

      l2_lag->l1 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      l2_lag->l3 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      }
      ")

```


### Group 2 Model (N=10)

```{r,echo=FALSE, fig.show='hold',fig.width=7}
library(DiagrammeR)
grViz("
digraph SEM {
      
      graph [layout = neato,
      overlap = FALSE,
      outputorder = nodesfirst]
      
      node [shape = rectangle, fixedsize = TRUE, 
            height = 1.6, fontsize = 32, color = 'blue', 
            style ='filled', fontcolor = 'white']
      
      v1_lag  [pos = '0, 3!',  label = 'V1lag', shape = square]
      v2_lag  [pos = '2, 3!',  label = 'V2lag', shape = square]
      v3_lag  [pos = '4, 3!',  label = 'V3lag', shape = square]
      l1_lag [pos = '2, 0!', label = 'L1lag', shape = circle]
      l1_lag->v1_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1_lag->v2_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1_lag->v3_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]

      v1  [pos = '18, 3!',  label = 'V1', shape = square]
      v2  [pos = '20, 3!',  label = 'V2', shape = square]
      v3  [pos = '22, 3!',  label = 'V3', shape = square]
      l1 [pos = '20, 0!', label = 'L1', shape = circle]
      l1->v1 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1->v2 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l1->v3 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]


      v4_lag  [pos = '0, -2!',  label = 'V4lag', shape = square]
      v5_lag  [pos = '2, -2!',  label = 'V5lag', shape = square]
      v6_lag  [pos = '4, -2!',  label = 'V6lag', shape = square]
      l2_lag [pos = '2, -5!', label = 'L2lag', shape = circle]
      l2_lag->v4_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2_lag->v5_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2_lag->v6_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]

      v4  [pos = '18, -2!',  label = 'V4', shape = square]
      v5  [pos = '20, -2!',  label = 'V5', shape = square]
      v6  [pos = '22, -2!',  label = 'V6', shape = square]
      l2 [pos = '20, -5!', label = 'L2', shape = circle]
      l2->v4 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2->v5 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l2->v6 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]


      v7_lag  [pos = '0, -7!',  label = 'V7lag', shape = square]
      v8_lag  [pos = '2, -7!',  label = 'V8lag', shape = square]
      v9_lag  [pos = '4, -7!',  label = 'V9lag', shape = square]
      l3_lag [pos = '2, -10!', label = 'L3lag', shape = circle]
      l3_lag->v7_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3_lag->v8_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3_lag->v9_lag [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]

      v7  [pos = '18, -7!',  label = 'V7', shape = square]
      v8  [pos = '20, -7!',  label = 'V8', shape = square]
      v9  [pos = '22, -7!',  label = 'V9', shape = square]
      l3 [pos = '20, -10!', label = 'L3', shape = circle]
      l3->v7 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3->v8 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]
      l3->v9 [label = '', tailport = 'n',headport = 's',penwidth = 1.5, arrowsize = 3]


      l1_lag->l1 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      l2_lag->l2 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      l3_lag->l3 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]

      l3_lag->l2 [label = '', tailport = 'e',headport = 'w', penwidth = 1.5, arrowsize = 4]
      }
      ")

```


## Specifying the Measurement Model

Latent variable GIMME requires a measurement model is specified in the <tt>lv_model</tt> argument.  This measurement model should follow <tt>lavaan</tt> model syntax using the "=~" operator (read as "measured by"). For both groups described above the data generating model can be expressed as follows:

```{r}
lv_model_all <- '
  L1 =~ V1 + V2 + V3 
  L2 =~ V4 + V5 + V6
  L3 =~ V7 + V8 + V9
'
```


### Individual-Specific Measurement Models

Latent variable GIMME also allows for individual-specific measurement models. In this case the object specificed in <tt>lv_model</tt> argument should be a list of length equal to the number of subjects in the analysis. We do not consider this option further here, however, if our analysis contained data from three individuals the list could be specified as follows:

```{r}
lv_model_ind1 <- '
  L1 =~ V1 + V2 + V3 
  L2 =~ V4 + V5 + V6
  L3 =~ V7 + V8 + V9
'

lv_model_ind2 <- '
  L1 =~ V7 + V5 + V3 
  L2 =~ V1 + V8 + V6
  L3 =~ V4 + V2 + V9
'

lv_model_ind3 <- '
  L1 =~ V4 + V2 + V9 
  L2 =~ V1 + V5 + V3
  L3 =~ V7 + V8 + V6
'

lv_model_ind <- list(
  lv_model_ind1, 
  lv_model_ind2, 
  lv_model_ind3
)
```


## Latent Variable Estimator

The second argument required to run latent variable GIMME is <tt>lv_estimator</tt>. Currently, three options for <tt>lv_estimator</tt> exist, <tt>miiv</tt>, <tt>pml</tt>, and <tt>svd</tt>. If the  <tt>miiv</tt> estimator is chosen the factor loadings for individual factor analysis models are estimated using MIIV-2SLS. In the case of the <tt>pml</tt> estimator, the factor loadings are estimated using the pseudo-ML estimator in <tt>lavaan</tt>. Finally, if <tt>svd</tt> is specified the first component for each set of indicators is obtained using singular value decomposition.  


## Score Type

If the user specified <tt>miiv</tt> or <tt>pml</tt> for the <tt>lv_estimator</tt> option, two types of factor scores can be obtained, <tt>bartlett</tt> or <tt>regression</tt>. The default is <tt>regression</tt>. See the <tt>lavaan</tt> documentation for details on these factor score types.

## Final Model Estimator

The default estimator for the final models is the MIIV-2SLS estimator (<tt>lv_final_estimator</tt> = <tt>miiv</tt>).  However, one can also estimate the final models using pseudo-ML (<tt>lv_final_estimator</tt> = <tt>pml</tt>).  


```{r}
fit <- gimme::gimmeSEM(
  data = gimme::simDataLV,
  out="~/Desktop/out",
  subgroup = TRUE,
  lv_model = lv_model_all,
  lv_estimator = "miiv",
  lv_score = "regression",
  lv_final_estimator = "miiv"
)
```

## Subgroup Recovery

The latent variable gimme algorithm correctly identifies the two subgroups as can be seen in the subgroup plots. Here the dashed lines indicate lagged effects.

### Subgroup 1
```{r, echo = TRUE}
 plot(qgraph::qgraph(fit$sub_plots[[1]]))
```

### Subgroup 2
```{r, echo = TRUE}
 plot(qgraph::qgraph(fit$sub_plots[[2]]))
```


### MIIV Parameter Estimates

Furthermore, we can also examine the final MIIV estimates.

```{r, eval = FALSE}
fit$lvgimme$miiv_est_table
```

```{r, echo = FALSE}
 df <- fit$lvgimme$miiv_est_table[,c("subj","lhs","op","rhs","est","se","z","pvalue")]
 df[,c(5:8)] <- round(df[,c(5:8)],3)
 df
```


